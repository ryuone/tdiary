<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
	<meta name="Author" content="TADA Tadashi">
	<link rev="MADE" href="mailto:sho@spc.gr.jp">
	<link rel="INDEX" href="http://www.tdiary.net/">
	<meta http-equiv="content-style-type" content="text/css">
	<link rel="stylesheet" href="../../theme/will.css" type="text/css" media="all">
	<title>tDiary README</title>
</head>
<body>
<h1>misc/plugin<br><span style="font-size:medium">〜 プラグイン・サンプル集と作り方 〜</span></h1>

<p>＃この記述は1.3.3.20010220現在の物です。1.3系は開発版なので、内容が陳腐化する可能性があります。</p>

<p>　misc/pluginディレクトリにある.rbファイルは、tDiary 1.3.1以降で使うことのできるプラグインファイルのサンプルです。ファイルごとインストール先にあるpluginディレクトリに移動することで、利用できるようになります。</p>

<p>　プラグインにはさまざまなものがありますが、日記中に自動的に何かの文字列を埋め込んだり、特殊な処理をさせるのが主な目的です。また、特定のプラグインを作ることで、tDiaryのメッセージをカスタマイズすることもできます。</p>

<p>　以下では、プラグインについてその「使い方」「サンプルの説明」「作り方」を説明します。なお、.rbファイルのことを「プラグインファイル」、実際に日記中で呼び出して使う機能(主にRubyのメソッド)のことを「プラグイン」と呼びます。ひとつのプラグインファイルは、複数のプラグインを含みます。</p>

<h2><span class="title">プラグインの使い方</span></h2>
<div class="body">
<p>　プラグインを使うには、そのプラグインを含んだプラグインファイルが、tDiaryインストール先にあるpluginディレクトリになければなりません。あらかじめ使いたいプラグインファイルをpluginディレクトリにコピーしておく必要があります。プラグインの中には高機能で処理に時間のかかるものも含まれているので、必要でないプラグインまでコピーすると、日記の表示が遅くなったりします。必要なプラグインだけを使うように、きちんと選択してください。</p>

<p>　プラグインは、eRubyと呼ばれる文法を使って、日記のタイトルや本文、ヘッダやフッタに埋め込むことで利用できます。「calendar」や「navi」というデフォルトプラグインは、すでにヘッダの中で使っているので見たことがあるでしょう。プラグインの機能を日記に埋め込むときのもっとも簡単な書式は以下のとおりです。</p>

<div class="section">
<pre>
&lt;%=プラグイン名%&gt;
</pre>
</div>

<p>　たとえば、カレンダーを埋め込むプラグイン「calendar」は、以下のようにして記述します。</p>

<div class="section">
<pre>
&lt;%=calendar%&gt;
</pre>
</div>

<p>　プラグインの種類によっては、以下のようにパラメタを指定して動作を変えることもできます。</p>

<div class="section">
<pre>
&lt;%=プラグイン名 パラメタ1, パラメタ2, ...%&gt;
</pre>
</div>

<p>　各プラグインがどのようなパラメタを利用できるかは、プラグインファイルの先頭の方に書かれていることがあります。</p>

<p>　プラグインを使えるのは、日記のタイトルと本文、およびヘッダとフッタです。日付フォーマットで使えるものもあります。すべてのページに表示したい場合にはヘッダかフッタを、その日の日記にだけ使いたい場合にはタイトルや本文に使います。また、ツッコミには使えません。</p>
</div>

<h2><span class="title">デフォルトプラグインの説明</span></h2>
<div class="body">
<p>　サンプル以外に、「デフォルトプラグイン」というプラグインファイル「00default.rb」がすでにpluginディレクトリに置いてあります。まず、これらのプラグインについて説明します。</p>

<h3 class="subtitle">naviプラグイン</h3>
<div class="section">
<p>　日記ページの先頭にある、「トップ」「最新」「更新」などのナビゲーションボタンを表示するためのプラグインです。パラメタはありません。ヘッダやフッタに埋め込むことで、ページによって最適なボタンを表示します。このプラグインをどこかに埋め込んでおかないと、日記の更新ができなくなってしまいます。</p>
</div>

<div class="section">
<p>※もしnaviプラグインを埋め込み忘れてしまい、日記の更新ができなくなってしまったら、日記のURLの後ろに「update.rb」(環境によっては「update.cgi」など)を付けて呼び出してみましょう。更新ページが表示されます。</p>
</div>

<div class="section">
<p>※naviプラグインは、更新や設定のページに内部的に埋め込まれています。もとの挙動を大きく変えるような改造をすると、操作性を大きく損ねるおそれがあるので注意してください。</p>
</div>

<h3 class="subtitle">navi_userプラグイン</h3>
<div class="section">
<p>　naviプラグインから内部的に呼び出されているプラグインですが、単独で使うこともできます。このプラグインは、ナビゲーションボタンのうち、日記閲覧者にのみ必要なボタン(「トップ」「最新」「<前日」「翌日>」)を表示します。これを使うことで、「更新」のような日記オーナーにだけ必要なボタンを表示させないなどのカスタマイズを行えます。</p>
</div>

<div class="section">
<p>　パラメタはありませんが、naviプラグインを使う場合に比べて、前後のPタグが省略されるので、以下のようにして埋め込むと良いでしょう。</p>
</div>

<div class="section">
<pre>
&lt;p class="adminmenu"&gt;&lt;%=navi_user%&gt;&lt;/p&gt;
</pre>
</div>

<h3 class="subtitle">navi_adminプラグイン</h3>
<div class="section">
<p>　navi_userプラグインと反対に、管理用に必要なボタン「更新」「設定」を表示します。使い方はnavi_userと同じです。</p>
</div>

<h3 class="subtitle">calendarプラグイン</h3>
<div class="section">
<p>　カレンダーを表示します。日記が書かれている月のみをリストします。ヘッダやフッタに埋め込んで使います。パラメタはありません。このプラグインをどこかに入れておかないと、日記閲覧者は過去の日記を読むことができなくなってしまいます。</p>
</div>

<h3 class="subtitle">insertプラグイン</h3>
<div class="section">
<p>　外部ファイルを日記に読み込みます。主な用途は、ヘッダやフッタに、すでにある定型ファイルを挿入したいような場合です。そのままの形で埋め込むので、挿入するファイルはHTMLでなければなりません。パラメタとしてひとつのファイル名をとるので、以下のように使います。</p>
</div>

<div class="section">
<pre>
&lt;%=insert 'menu.html'%&gt;
</pre>
</div>

<div class="section">
<p>　このプラグインは、ファイルにアクセスするため、tdiary.confで@secureがfalseに設定されていないと利用できません。</p>
</div>

<h3 class="subtitle">myプラグイン</h3>
<div class="section">
<p>　日記本文中で、自分の日記内へのリンクを簡単に作成します。&lt;a href="〜"&gt;...&lt;/a&gt;とやってもよいのですが、こちらの方がサーバの引っ越しやmod_rewriteを利用してURLを変更した場合などに強くできます。</p>
<p>　最初のパラメタにリンク先の日付とアンカーを「YYYYMMDD#pXX」(YYYY年MM月DD日のXX番目のセクション)や「YYYYMMDD#cXX」(YYYY年MM月DD日のXX番目のツッコミ)のような形式で指定します。2番目のパラメタには、リンクにする文字列を指定します。</p>
</div>

<div class="section">
<pre>
&lt;%=my '20020301#c01', 'そのツッコミ' %&gt;はひどい(笑)。
</pre>
</div>

<h2><span class="title">サンプルプラグインの説明</span></h2>
<p>　続いて、サンプルプラグインについて説明します。以下のプラグインは自分でpluginディレクトリに移動しなければ使うことはできません。</p>

<h3 class="subtitle">title_listプラグイン</h3>
<div class="section">
<p>　title_list.rbファイルに含まれています。現在表示中の月のタイトル一覧を表示します。ヘッダやフッタに埋め込んで使います。単に一覧を表示するだけなので、きちんとレイアウトするにはtableタグを使ったり、CSS(テーマファイル)を書き換える等の工夫が必要になります。</p>
</div>

<h3 class="subtitle">srcプラグイン</h3>
<div class="section">
<p>　src.rbファイルに含まれています。日記本文に外部にあるファイルを埋め込むために使います。デフォルトプラグインのinsertとの違いは、insertがファイルの中身をそのまま埋め込むのに対し、srcは「&lt;」「&gt;」「&amp;」などのHTML的に意味のある文字がそのまま表示されるように「&amp;lt;」「&amp;gt;」「&amp;amp;」等で置換してくれる点です。このため、srcプラグインは普通のテキストファイルやプログラムのリストを埋め込むのに適しています。</p>
</div>

<div class="section">
<p>　なお、insertと同様、このプラグインも@secureがfalseでないと使えません。</p>
</div>

<h3 class="subtitle">src_inlineプラグイン</h3>
<div class="section">
<p>　src.rbファイルに含まれています。srcプラグインと違い、パラメタに直接文字列を指定するタイプです。何がうれしいかと言うと、srcと同様、HTML的に意味のある文字をエスケープしてくれる点です。1行だけの文字列であれば以下のように使えますが、</p>
</div>

<div class="section">
<pre>
&lt;%=src_inline 'HTMLのタグは「&lt;」で始まり「&gt;」で終わります'%&gt;
</pre>
</div>

<div class="section">
<p>複数行に渡るような場合には以下のようにすると楽でしょう(Rubyのヒアドキュメント機能を活用)。</p>
</div>

<div class="section">
<pre>
&lt;%=src_inline &lt;&lt;TEXT
HTMLのタグは「&lt;」で始まり「&gt;」で終わります。
このため、文章中に「&lt;」を書くときは「&amp;lt;」、
「&gt;」を書くときは「&amp;gt;」と書かねばなりませ
んが、src・src_inlineプラグインではそのよう
なことを考えなくても大丈夫です。
TEXT
%&gt;
</pre>
</div>

<div class="section">
<p>　また、挿入する文章に空改行が含まれている場合は注意が必要です。tDiaryの文法では、空改行はセクションの終了を意味するので、このままだとそこでセクションが切られてしまいます。空改行がある場合には、空白をひとつ入れる等の工夫をして下さい。</p>
</div>

<h3 class="subtitle">calendarプラグイン(ドロップダウンリスト)</h3>
<div class="section">
<p>　dropdown_calendar.rbには、デフォルトのcalendarを置き換えるプラグインが含まれています。このように、同名のプラグインを作ると、元のプラグインを置き換えることが可能です。<p>
</div>

<div class="section">
<p>　dropdown_calendar.rbのcalendarプラグインは、一覧形式でカレンダーを表示するデフォルトのcalendarと違い、ドロップダウンリストとしてカレンダーを表示します。長年日記を続けて、デフォルトのカレンダーが大きくなりすぎたら、このプラグインを使ってみるといいかも知れません。使い方はデフォルトのcalendarと全く同じです。</p>
</div>

<h3 class="subtitle">editプラグイン</h3>
<div class="section">
<p>　日毎表示の時に、ナビゲーションボタンの「更新」を「編集」に置き換えるプラグインです。標準の「更新」ボタンは今日の日記を追加するモードになりますが、editプラグインを入れて「編集」にすることで、現在表示されている日記を直接編集できるようになります。</p>
</div>

<h3 class="subtitle">calendar2プラグイン(kitaj作)</h3>
<div class="section">
<p>　一般的なカレンダーと同じ表形式を使って、過去の日記にアクセスできるようにするプラグインです。ヘッダやフッタに入れて使います。詳しくはcalendar2.rbを見てください。</p>
</div>

<h3 class="subtitle">recent_listプラグイン(kitaj作)</h3>
<div class="section">
<p>　最近書いた日記のタイトル、サブタイトルを表示します。title_listプラグインとの違いは、常に最新の日記を対象にする点です。ヘッダやフッタに入れて使いますが、テーブルを使うか、テーマを書き換えてレイアウトを工夫しないと使えないでしょう。詳しくはrecent_list.rbを見てください。</p>
</div>

<h3 class="subtitle">recent_commentプラグイン(zoe作)</h3>
<div class="section">
<p>　最近あったツッコミを新しい順にリストアップします。ヘッダやフッタに入れて使います。詳しくはrecent_comment.rbを見てください。</p>

<h3 class="subtitle">comment_rankプラグイン(zoe作)</h3>
<div class="section">
<p>　ツッコミの数でランキングを作ります。ヘッダやフッタに入れて使います。詳しくはcomment_rank.rbを見てください。</p>
</div>

</div>

<h2><span class="title">プラグインの作り方</span></h2>
<p>　プラグインは、Rubyのメソッドになっています。これらのメソッドはプラグインを実装するPluginクラスのメソッドとして読み込まれ、日記ファイル生成時の最後の段階で呼び出されます。プラグインメソッドは文字列を返し、それがそのまま日記に埋め込まれることになります。</p>

<h3 class="subtitle">メッセージのカスタマイズ</h3>
<div class="section">
<p>　このプラグインメソッドの動作を利用して、日記に埋め込まれるいくつかの文字列はカスタマイズできるようになっています。プラグイン作成のうちもっとも簡単なこのカスタマイズをこれから見ていきます。</p>
</div>

<div class="section">
<p>　カスタマイズ可能な文字列は、デフォルトプラグインとしてあらかじめ以下のように定義されています。</p>
</div>

<div class="section">
<pre>
def comment_today; '本日のツッコミ'; end
def comment_total( total ); "(全#{total}件)"; end
def comment_new; 'ツッコミを入れる'; end
def comment_description; 'ツッコミ・コメントがあればどうぞ! E-mailアドレスは公開されません。'; end
def comment_description_short; 'ツッコミ!!'; end
def comment_name_label; 'お名前'; end
def comment_name_label_short; '名前'; end
def comment_mail_label; 'E-mail'; end
def comment_mail_label_short; 'Mail'; end
def comment_body_label; 'コメント'; end
def comment_body_label_short; '本文'; end
def comment_submit_label; '投稿'; end
def comment_submit_label_short; '投稿'; end
def comment_date( time ); time.strftime( "(#{@date_format} %H:%M)" ); end
def referer_today; '本日のリンク元'; end
</pre>
</div>

<div class="section">
<p>　これらのメソッドを再定義することで、別の文字列を埋め込むことが可能です。</p>
</div>

<div class="section">
<p>　まず、自分のカスタマイズ用プラグインファイルを用意します。pluginディレクトリに、例えば「custom.rb」という名前でファイルを作ります。自分の日記の雰囲気には「ツッコミ」という言葉がしっくり来ないという場合を想定して、これらを書き換えることにしましょう。ツッコミという言葉を使っている4つのメソッドをcustom.rbにコピーして、「コメント」という言葉に置き換えます。</p>
</div>

<div class="section">
<pre>
def comment_today; '本日のコメント'; end
def comment_new; 'コメントを入れる'; end
def comment_description; 'コメントがあればどうぞ! E-mailアドレスは公開されません。'; end
def comment_description_short; 'コメント'; end
</pre>
</div>

<div class="section">
<p>　これだけでOKです。日記を表示して、変化していることを確認しましょう(スーパーリロードしないと変化しないかも知れません)。</p>
</div>

<div class="section">
<p>　他にも、カスタマイズ用プラグインとして「theme_url」が用意されています。</p>
</div>

<div class="section">
<pre>
def theme_url; 'theme'; end
</pre>
</div>

<div class="section">
<p>　このプラグインは、テーマファイルが置かれているURLを指定するものです。通常はインストール先のthemeディレクトリなのでこのままで大丈夫ですが、同一サーバで複数の日記を運用している場合など、テーマファイルを一か所に集めたい場合には、これを使わないとテーマが読み込まれません。</p>
</div>

<div class="section">
<p>　カスタマイズするときは、「'theme'」の代わりにテーマファイルのあるディレクトリのURLを指定します。URLの最後を「/」で終わってはいけません。</p>
</div>

<div class="section">
<p>　このほかにも、navi_userやnavi_adminを再定義することで、ナビゲーションボタンのラベルを変更することもできます。また00default.rbにはこれ以外にも、HTMLのヘッダ情報を生成する以下のようなプラグインが定義されています(詳しくはコードを読んでください)。</p>
</div>

<div class="section">
<ul>
<li><code>author_name</code>: 著者名を示すmetaタグを生成</li>
<li><code>author_mail</code>: 著者のメールアドレスを示すmetaタグを生成</li>
<li><code>index_page</code>: INDEXを示すmetaタグを生成</li>
<li><code>css_tag</code>: スタイルシートの利用を指示するタグを生成</li>
<li><code>title_tag</code>: titleタグを生成</li>
</ul>
</div>

<h3 class="subtitle">オリジナルプラグインの実装</h3>
<div class="section">
<p>　以下では、Rubyのコードが書ける人を対象に、オリジナルのプラグインを実装する方法を解説します。と言っても、文字列を返すメソッドを書くだけなので難しいことはありません。ここでは、プラグイン内で利用できるインスタンス変数の解説だけ行います。</p>
</div>

<div class="section">
<p>　プラグインは専用のPluginクラスの内部で実行されるので、その中にある変数にしかアクセスできません。tDiaryの他の部分に影響が出ないようになっています。もっとも、evalを使って再定義してしまうことで、いくらでも自由になるのですが。</p>
</div>

<div class="section">
<p>　Pluginクラスのインスタンス変数には以下のものがあります。</p>
</div>

<div class="section">
<table border style="margin-left: 3em;">
<tr><th>@mode</th><td>現在動作中のモードを表現する文字列です。tdiary.rb中で使われているTDiaryクラスの策クラス名から、TDiaryを取って、downcaseしたものが含まれています。上手に利用するにはtDiaryの内部構造を知っている必要があるでしょう(いずれちゃんと説明書きます。すまぬ)</td></tr>
<tr><th>@diaries</th><td>日記データを保持するDiaryインスタンスのHashです。現在表示対象になっている日付を含む月全体が含まれます(最新表示で月をまたいでいる場合は、2ヶ月分含まれることがあります)。Hashのキーは「yyyymmdd」形式の日付で、Hashの値がDiaryインスタンスです。</td></tr>
<tr><th>@cgi</th><td>CGIクラスのインスタンスで、現在実行中のCGIに渡されてきたパラメタやCookieのデータが含まれています。スクリプトのパスや、パラメタの値を取得したい場合に利用できます。。</td></tr>
<tr><th>@years</th><td>現存するすべての日記の年月データを保持するHashです。キーは年、値は月のArrayです。</td></tr>
<tr><th>@cache_path</th><td>キャッシュファイルのあるディレクトリ。プラグインでキャッシュを使いたい場合は、ここに独自のディレクトリを掘って利用します。</td></tr>
<tr><th>@index</th><td>日記の本体を示すページのURLです。デフォルトは「./」。tdiary.confで指定した物と同じです。</td></tr>
<tr><th>@update</th><td>日記の更新ページを示すURLです。デフォルトは「update.rb」。tdiary.confで指定した物と同じです。</td></tr>
<tr><th>@author_name</th><td>日記著者(あなた)の名前です。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@author_mail</th><td>日記著者(あなた)のE-mailアドレスです。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@index_page</th><td>トップページのURLです。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@html_title</th><td>日記のタイトル。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@date</th><td>現在表示中の日付。特定の日か、月を表現したものかどうかは、@modeを見なければ判断できません。</td></tr>
<tr><th>@date_format</th><td>日付のフォーマットを示す文字列。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@referer_table</th><td>「本日のリンク元」で特定のURLを指定した文字列に変換するためのテーブル。Hashです。</td></tr>
</table>
</div>

<h3 class="subtitle">コールバック系プラグイン</h3>
<div class="section">
<p>　上で説明した、単に文字列を返すメソッドを定義してそれを日記本文に埋め込んで使うだけのプラグインと違い、特定の状況でのみ呼び出されるようなコールバック系プラグインがあります。tDiaryの機能を拡張するために利用できます。以下にその作り方を解説します。</p>
</div>

<div class="section">
<p>　コールバック系のプラグインは現在、以下の4種類定義されています。</p>
</div>

<div class="section">
<ul>
	<li><code>update_proc</code>: 日記更新時およびツッコミ追加時に呼び出される</li>
	<li><code>header_proc</code>: HTMLヘッダ情報の生成時に呼び出される</li>
	<li><code>body_enter_proc</code>: 日記本文開始の直前で呼び出される。パラメタに処理中の日記の日付(Timeインスタンス)が与えられる</li>
	<li><code>body_leave_proc</code>: 日記本文終了の直後に呼び出される。パラメタに処理中の日記の日付(Timeインスタンス)が与えられる</li>
</ul>
</div>

<div class="section">
<p>　いずれも通常のプラグインと同様にメソッドとして実装されていますが、上書き定義してはいけません。上書きすると、この機能を使っている他のプラグインが呼び出されなくなってしまうためです。</p>
</div>

<div class="section">
<p>　このため、これらのプラグインには機能を追加するためのメソッド、<code>add_update_proc</code>と<code>add_header_proc</code>、<code>add_body_enter_proc</code>、<code>add_body_leave_proc</code>が用意されています。これらはProcインスタンスを引数に持ちます。ここで登録されたProcが順番に呼び出されることで、複数のプラグインが実行されます。これらのプラグインは以下のように定義して使います。</p>
</div>

<div class="section"><pre>
# 検索キーワードをheadに挿入する
add_header_proc( Proc::new do
   '&lt;meta name="keyword" content="Linux,Kondara"&gt;'
end )
</pre></div>

<div class="section">
<p>　なお、コールバック系プラグインはそれぞれのProcインスタンスが返した文字列をすべて連結してHTMLに埋め込みますが、<code>update_proc</code>は何も埋め込みません(意味がないので)。このため、<code>update</code>用に追加するProcは何も返す必要はありません。</p>
</div>

<div class="section">
<p>　デフォルトプラグインファイルである00default.rbには、標準のHTMLヘッダを生成するheader_proc用Procが定義されています。</p>
</div>

</body>
</html>
