<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
	<meta name="Author" content="TADA Tadashi">
	<link rev="MADE" href="mailto:sho@spc.gr.jp">
	<link rel="INDEX" href="http://www.tdiary.net/">
	<meta http-equiv="content-style-type" content="text/css">
	<link rel="stylesheet" href="doc.css" type="text/css" media="all">
	<title>tDiary: How to make plugin</title>
</head>
<body>
<h1>tDiary<br><span style="font-size:medium">IOクラスの作り方</span></h1>

<div class="section">
<p>　tDiaryは、日記記述フォーマットや保存形式を差し替えることができます。これを実現するための仕組みを総称して「IOクラス」と呼んでいます(RubyのIOクラスとは違います)。</p>
</div>

<h2><span class="title">保存形式の差し替え</span></h2>
<div class="section">
<p>　保存形式を変更するには、TDiary::IOBaseクラスを継承したクラスを実装します。このクラスで実装すべきなのは以下のメソッドです。</p>

<h3 class="subtitle">calendar</h3>
<p>　tDiaryに、日記が存在する年月を通知するためのメソッドです。実行時にtDiaryから呼び出されます。</p>
<p>　返り値には、現在利用できる日記が含まれている年・月を、Hashオブジェクトで返します。Hashに含まれている各値は、キーに西暦年(Stringで4文字)、対応する値にはArrayで月(Stringで2桁)を設定します。以下に例を示します。</p>
<pre>
def calendar
   return {
      '2001' => ['12'],
      '2002' => ['01', '02', '03', '04', '05', '08']
   }
end
</pre>

<h3 class="subtitle">transaction( date )</h3>
<p>　指定された月の日記データを読み込み、tDiaryに理解できる形で渡します。</p>
<p>　引数dateはTimeオブジェクトで、年と月のみがlocaltimeで与えられます。</p>
<p>　transactionメソッドはdateで指定された月の日記データをファイル(またはその他の媒体)から読み出して、ブロックパラメタとしてtDiaryに返します。このブロックパラメタはHashで、キーに年月(Stringで6桁)、値にDiaryBase(またはそれを継承したクラス)を持ちます。</p>
<p>　ブロックパラメタを受けとったtDiaryは、それを使って日記を表示または更新するので、transactionメソッドはその返り値に従って日記を保存する等の処理を行えます。以下にtDiaryからの返り値を示します。</p>
<pre>
TDiary::DIRTY_NONE: 日記データに変更はありませんでした
TDiary::DIRTY_DIARY: 日記本文に変更がありました
TDiary::DIRTY_COMMENT: ツッコミに変更がありました
TDiary::DIRTY_REFERER: リンク元に変更がありました
</pre>
<p>　以下にtransactionの例を示します。</p>
<pre>
def trasaction( date )
   diaries = { ... } # restore data
   case yield( diaries )
   when TDiary::DIRTY_DIARY
      ... # saving diary data
   when TDiary::DIRTY_COMMENT
      ... # saving comment data
   when TDiary::DIRTY_REFERER
      ... # saving referer data
   end
end
</pre>

<h3 class="subtitle">diary_factory( date, title, body, format = nil )</h3>
<p>　diary_factoryは、指定されたフォーマットの日記オブジェクトを生成して返します。</p>
<p>　引数dateは日付(Stringで8桁)を指定します。title、bodyはそれぞれ生成する日記のタイトルと本文です(String)。formatは日記の記述形式を指定する文字列で、diary_factoryに依存します。</p>
<p>　返り値はDiaryBaseをincludeした継承したクラスのオブジェクトです。</p>
<p>　以下にdiary_factoryの例を示します。</p>
<pre>
def diary_factory( date, title, body, format = nil )
   case format
   when 'tDiary'
      TDiaryDiary::new( date, title, body )
   default
      raise StandardError, 'bad format'
   end
end
</pre>

</div>

</body>
</html>
